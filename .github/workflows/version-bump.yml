name: Version Bump

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  bump-patch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Bump patch version
        id: bump
        run: |
          set -euo pipefail
          current=$(tr -d '[:space:]' < VERSION)
          if [[ ! "$current" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Invalid VERSION format: $current"
            exit 1
          fi

          major="${BASH_REMATCH[1]}"
          minor="${BASH_REMATCH[2]}"
          patch="${BASH_REMATCH[3]}"
          next="${major}.${minor}.$((patch + 1))"

          echo "$next" > VERSION
          echo "next_version=$next" >> "$GITHUB_OUTPUT"

      - name: Commit and push version bump
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add VERSION
          git commit -m "chore: bump version to ${{ steps.bump.outputs.next_version }} [skip ci]"
          git push
